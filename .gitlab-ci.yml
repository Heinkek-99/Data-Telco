variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
  MONGODB_URI: "mongodb://mongodb:27017"

stages:
  - lint
  - build
  - test
  - security
  - deploy-staging
  - deploy-production

# ============== LINT STAGE ==============

lint-backend:
  stage: lint
  image: python:3.10
  before_script:
    - cd backend
    - pip install flake8 black isort mypy
  script:
    - echo "üîç Linting backend code..."
    - flake8 . --max-line-length=120 --exclude=venv,__pycache__
    - black --check .
    - isort --check-only .
    - mypy server.py --ignore-missing-imports
  only:
    changes:
      - backend/**/*
  allow_failure: true

lint-frontend:
  stage: lint
  image: node:18
  before_script:
    - cd frontend
    - yarn install
  script:
    - echo "üîç Linting frontend code..."
    - yarn run lint
  only:
    changes:
      - frontend/**/*
  allow_failure: true

# ============== BUILD STAGE ==============

build-backend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üèóÔ∏è Building backend Docker image..."
    - cd backend
    - docker build -t $BACKEND_IMAGE .
    - docker push $BACKEND_IMAGE
    - echo "‚úÖ Backend image pushed to registry"
  only:
    changes:
      - backend/**/*
  tags:
    - docker

build-frontend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "üèóÔ∏è Building frontend Docker image..."
    - cd frontend
    - docker build -t $FRONTEND_IMAGE .
    - docker push $FRONTEND_IMAGE
    - echo "‚úÖ Frontend image pushed to registry"
  only:
    changes:
      - frontend/**/*
  tags:
    - docker

# ============== TEST STAGE ==============

test-backend:
  stage: test
  image: python:3.10
  services:
    - mongo:6.0
  variables:
    MONGO_URL: "mongodb://mongo:27017"
    DB_NAME: "telco_test"
    JWT_SECRET: "test-secret-key"
  before_script:
    - cd backend
    - pip install -r requirements.txt
    - pip install pytest pytest-asyncio httpx
  script:
    - echo "üß™ Running backend tests..."
    - pytest tests/ -v --tb=short
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      junit: backend/test-results.xml
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml
  only:
    changes:
      - backend/**/*

test-frontend:
  stage: test
  image: node:18
  before_script:
    - cd frontend
    - npm ci
  script:
    - echo "üß™ Running frontend tests..."
    - npm run test -- --coverage --watchAll=false
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      junit: frontend/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: frontend/coverage/cobertura-coverage.xml
  only:
    changes:
      - frontend/**/*

# ============== SECURITY STAGE ==============

security-scan-backend:
  stage: security
  image: python:3.10
  before_script:
    - cd backend
    - pip install safety bandit
  script:
    - echo "üîí Scanning backend dependencies for vulnerabilities..."
    - safety check --json
    - bandit -r . -f json -o bandit-report.json
  artifacts:
    reports:
      sast: backend/bandit-report.json
  allow_failure: true

security-scan-frontend:
  stage: security
  image: node:18
  before_script:
    - cd frontend
    - npm ci
  script:
    - echo "üîí Scanning frontend dependencies..."
    - npm audit --audit-level=moderate
  allow_failure: true

container-scanning:
  stage: security
  image: aquasec/trivy:latest
  script:
    - echo "üê≥ Scanning Docker images for vulnerabilities..."
    - trivy image $BACKEND_IMAGE --severity HIGH,CRITICAL --exit-code 0
    - trivy image $FRONTEND_IMAGE --severity HIGH,CRITICAL --exit-code 0
  allow_failure: true

# ============== STAGING DEPLOYMENT ==============

deploy-staging:
  stage: deploy-staging
  image: docker/compose:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "üöÄ Deploying to staging environment..."
    - docker-compose -f docker-compose.staging.yml down
    - docker-compose -f docker-compose.staging.yml up -d
    - sleep 10
    - curl -f http://staging.telco-api.com/api/health || exit 1
  environment:
    name: staging
    url: https://staging.telco-api.com
  only:
    - develop
  tags:
    - staging

smoke-test-staging:
  stage: deploy-staging
  image: curlimages/curl:latest
  script:
    - echo "üß™ Running smoke tests on staging..."
    - curl -f https://staging.telco-api.com/api/health
    - curl -f https://staging.telco-app.com
  only:
    - develop
  needs:
    - deploy-staging

# ============== PRODUCTION DEPLOYMENT ==============

deploy-production-backend:
  stage: deploy-production
  image: docker/compose:latest
  before_script:
    - apk add --no-cache curl openssh
  script:
    - echo "üöÄ Deploying backend to production..."
    - |
      ssh -o StrictHostKeyChecking=no $PROD_SERVER << 'EOF'
        cd /var/www/telco-analytics
        docker-compose pull backend
        docker-compose up -d backend
        docker system prune -af
      EOF
    - sleep 15
    - curl -f https://api.telco-analytics.com/api/health || exit 1
  environment:
    name: production
    url: https://api.telco-analytics.com
  only:
    - main
  when: manual
  tags:
    - production

deploy-production-frontend:
  stage: deploy-production
  image: node:18
  before_script:
    - cd frontend
    - npm ci
  script:
    - echo "üöÄ Building and deploying frontend to production..."
    - npm run build
    - echo "Deploying to Vercel/Netlify..."
    # Exemple avec Vercel
    - npm install -g vercel
    - vercel --prod --token=$VERCEL_TOKEN --yes
  environment:
    name: production-frontend
    url: https://telco-analytics.com
  only:
    - main
  when: manual

# ============== ROLLBACK ==============

rollback-production:
  stage: deploy-production
  image: docker/compose:latest
  script:
    - echo "‚è™ Rolling back to previous version..."
    - |
      ssh -o StrictHostKeyChecking=no $PROD_SERVER << 'EOF'
        cd /var/www/telco-analytics
        docker-compose down
        docker-compose -f docker-compose.backup.yml up -d
      EOF
  environment:
    name: production
  when: manual
  only:
    - main

# ============== NOTIFICATIONS ==============

.notify-success:
  after_script:
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
        -H 'Content-Type: application/json' \
        -d "{\"text\":\"‚úÖ Pipeline succeeded for $CI_PROJECT_NAME on branch $CI_COMMIT_REF_NAME\"}"

.notify-failure:
  after_script:
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
        -H 'Content-Type: application/json' \
        -d "{\"text\":\"‚ùå Pipeline failed for $CI_PROJECT_NAME on branch $CI_COMMIT_REF_NAME. Job: $CI_JOB_NAME\"}"