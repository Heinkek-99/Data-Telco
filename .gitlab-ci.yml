variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  Backend_IMAGE: $CI_REGISTRY_IMAGE/Backend:$CI_COMMIT_SHORT_SHA
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
  MONGODB_URI: "mongodb://mongodb:27017"
  NODE_ENV: production

stages:
  - lint
  - build
  - test
  - security
  - deploy-staging
  - deploy-production

# ============================
#        LINT STAGE
# ============================

lint-Backend:
  stage: lint
  image: python:3.10
  before_script:
    - cd Backend
    - pip install flake8 black isort mypy
  script:
    - echo "üîç Linting Backend..."
    - black --check .
    - isort --check-only .
    - flake8 .
    - mypy server.py --ignore-missing-imports
  only:
    changes:
      - Backend/**/*
  allow_failure: true

lint-frontend:
  stage: lint
  image: node:18
  before_script:
    - cd frontend
    - yarn install --frozen-lockfile
  script:
    - echo "üîç Linting frontend..."
    - yarn lint
  only:
    changes:
      - frontend/**/*
  allow_failure: true

# ============================
#        BUILD STAGE
# ============================

build-Backend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    - echo "üèóÔ∏è Building Backend image..."
    - cd Backend
    - docker build -t "$Backend_IMAGE" .
    - docker push "$Backend_IMAGE"
  only:
    changes:
      - Backend/**/*
  tags:
    - docker

build-frontend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    - echo "üèóÔ∏è Building frontend image..."
    - cd frontend
    - docker build -t "$FRONTEND_IMAGE" .
    - docker push "$FRONTEND_IMAGE"
  only:
    changes:
      - frontend/**/*
  tags:
    - docker

# ============================
#        TEST STAGE
# ============================

test-Backend:
  stage: test
  image: python:3.10
  services:
    - mongo:6.0
  variables:
    MONGO_URL: "mongodb://mongo:27017"
    DB_NAME: "telco_test"
    JWT_SECRET: "test-secret-key"
  before_script:
    - cd Backend
    - pip install -r requirements.txt
    - pip install pytest pytest-asyncio httpx
  script:
    - echo "üß™ Running Backend tests..."
    - python tests/ -v --tb=short
  artifacts:
    reports:
      junit: Backend/test-results.xml
  only:
    changes:
      - Backend/**/*

test-frontend:
  stage: test
  image: node:18
  before_script:
    - cd frontend
    - yarn install --frozen-lockfile
  script:
    - echo "üß™ Running frontend tests..."
    - yarn test --coverage --watchAll=false
  artifacts:
    reports:
      junit: frontend/junit.xml
  only:
    changes:
      - frontend/**/*

# ============================
#        SECURITY STAGE
# ============================

security-scan-Backend:
  stage: security
  image: python:3.10
  before_script:
    - cd Backend
    - pip install safety bandit
  script:
    - echo "üîí Scanning Backend..."
    - safety check --json
    - bandit -r . -f json -o bandit-report.json
  artifacts:
    reports:
      sast: Backend/bandit-report.json
  allow_failure: true

security-scan-frontend:
  stage: security
  image: node:18
  before_script:
    - cd frontend
    - yarn install --frozen-lockfile
  script:
    - echo "üîí Scanning frontend..."
    - yarn audit --level moderate
  allow_failure: true

container-scanning:
  stage: security
  image: aquasec/trivy:latest
  script:
    - echo "üê≥ Scanning Docker images..."
    - trivy image "$Backend_IMAGE" --severity HIGH,CRITICAL --exit-code 0
    - trivy image "$FRONTEND_IMAGE" --severity HIGH,CRITICAL --exit-code 0
  allow_failure: true

# ============================
#     STAGING DEPLOYMENT
# ============================

deploy-staging:
  stage: deploy-staging
  image: docker/compose:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "üöÄ Deploying to staging..."
    - docker-compose -f docker-compose.staging.yml pull
    - docker-compose -f docker-compose.staging.yml up -d --remove-orphans
    - sleep 10
    - curl -f http://staging.telco-api.com/api/health
  environment:
    name: staging
    url: https://staging.telco-api.com
  only:
    - develop
  tags:
    - staging

smoke-test-staging:
  stage: deploy-staging
  image: curlimages/curl:latest
  script:
    - echo "üß™ Smoke tests..."
    - curl -f https://staging.telco-api.com/api/health
    - curl -f https://staging.telco-app.com
  needs:
    - deploy-staging
  only:
    - develop

# ============================
#    PRODUCTION DEPLOYMENT
# ============================

deploy-production-Backend:
  stage: deploy-production
  image: docker/compose:latest
  before_script:
    - apk add --no-cache curl openssh
  script:
    - echo "üöÄ Deploying Backend to production..."
    - |
      ssh -o StrictHostKeyChecking=no "$PROD_SERVER" << 'EOF'
        cd /var/www/telco-analytics
        docker-compose pull Backend
        docker-compose up -d Backend
        docker system prune -af
      EOF
    - sleep 15
    - curl -f https://api.telco-analytics.com/api/health
  environment:
    name: production
    url: https://api.telco-analytics.com
  only:
    - main
  when: manual
  tags:
    - production

deploy-production-frontend:
  stage: deploy-production
  image: node:18
  before_script:
    - cd frontend
    - yarn install --frozen-lockfile
  script:
    - echo "üöÄ Deploying frontend to Vercel..."
    - yarn build
    - yarn global add vercel
    - vercel --prod --token="$VERCEL_TOKEN" --yes
  environment:
    name: production-frontend
    url: https://telco-analytics.com
  only:
    - main
  when: manual

# ============================
#         ROLLBACK
# ============================

rollback-production:
  stage: deploy-production
  image: docker/compose:latest
  script:
    - echo "‚è™ Rolling back..."
    - |
      ssh -o StrictHostKeyChecking=no "$PROD_SERVER" << 'EOF'
        cd /var/www/telco-analytics
        docker-compose down
        docker-compose -f docker-compose.backup.yml up -d
      EOF
  environment:
    name: production
  only:
    - main
  when: manual
