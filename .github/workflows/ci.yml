name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  DOCKER_DRIVER: overlay2
  MONGODB_URI: "mongodb://mongodb:27017"

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [Backend, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: List files
        run: ls -R

      - name: Set up Python
        if: matrix.service == 'Backend'
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Lint Backend code
        if: matrix.service == 'Backend'
        run: |
          cd Backend
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy
          echo "üîß Formatting imports with isort..."
          isort .
          echo "üîß Formatting code with black..."
          black .
          echo "üîç Linting Backend code..."
          flake8 . --max-line-length=120 --exclude=venv,__pycache__
          black --check .
          isort --check-only .
          mypy server.py --ignore-missing-imports

      - name: Set up Node.js
        if: matrix.service == 'frontend'
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      - name: Lint frontend code
        if: matrix.service == 'frontend'
        run: |
          cd frontend
          yarn install
          echo "üîç Linting frontend code..."
          yarn run lint

  build:
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        service: [Backend, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build and push Backend Docker image
        if: matrix.service == 'Backend'
        run: |
          echo "üèóÔ∏è Building Backend Docker image..."
          cd Backend
          docker build -t ${{ secrets.DOCKER_REGISTRY }}/Backend:${{ github.sha }} .
          docker push ${{ secrets.DOCKER_REGISTRY }}/Backend:${{ github.sha }}

      - name: Build and push frontend Docker image
        if: matrix.service == 'frontend'
        run: |
          echo "üèóÔ∏è Building frontend Docker image..."
          cd frontend
          docker build -t ${{ secrets.DOCKER_REGISTRY }}/frontend:${{ github.sha }} .
          docker push ${{ secrets.DOCKER_REGISTRY }}/frontend:${{ github.sha }}

  test:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        service: [Backend, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python for Backend tests
        if: matrix.service == 'Backend'
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Install Backend dependencies and run tests
        if: matrix.service == 'Backend'
        run: |
          cd Backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx
          echo "üß™ Running Backend tests..."
          pytest tests/ -v --tb=short

      - name: Set up Node.js for frontend tests
        if: matrix.service == 'frontend'
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      - name: Install frontend dependencies and run tests
        if: matrix.service == 'frontend'
        run: |
          cd frontend
          npm ci
          echo "üß™ Running frontend tests..."
          npm run test -- --coverage --watchAll=false

  security:
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        service: [Backend, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python for security scan
        if: matrix.service == 'Backend'
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Security scan for Backend
        if: matrix.service == 'Backend'
        run: |
          cd Backend
          pip install safety bandit
          echo "üîí Scanning Backend dependencies for vulnerabilities..."
          safety check --json
          bandit -r . -f json -o bandit-report.json

      - name: Set up Node.js for security scan
        if: matrix.service == 'frontend'
        uses: actions/setup-node@v2
        with:
          node-version: '18'

      - name: Security scan for frontend
        if: matrix.service == 'frontend'
        run: |
          cd frontend
          npm ci
          echo "üîí Scanning frontend dependencies..."
          npm audit --audit-level=moderate

  deploy-staging:
    runs-on: ubuntu-latest
    needs: security
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy to staging
        run: |
          echo "üöÄ Deploying to staging environment..."
          docker-compose -f docker-compose.staging.yml down
          docker-compose -f docker-compose.staging.yml up -d
          sleep 10
          curl -f http://staging.telco-api.com/api/health || exit 1

  deploy-production:
    runs-on: ubuntu-latest
    needs: security
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy Backend to production
        run: |
          echo "üöÄ Deploying Backend to production..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER }} << 'EOF'
            cd /var/www/telco-analytics
            docker-compose pull Backend
            docker-compose up -d Backend
            docker system prune -af
          EOF

      - name: Deploy frontend to production
        run: |
          cd frontend
          npm ci
          echo "üöÄ Building and deploying frontend to production..."
          npm run build
          npm install -g vercel
          vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes

  notify:
    runs-on: ubuntu-latest
    if: always()  # Toujours ex√©cuter cette √©tape
    steps:
      - name: Notify success or failure
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
              -H 'Content-Type: application/json' \
              -d "{\"text\":\"‚úÖ Pipeline succeeded for ${{ github.event.repository.name }} on branch ${{ github.ref }}\"}"
          else
            curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
              -H 'Content-Type: application/json' \
              -d "{\"text\":\"‚ùå Pipeline failed for ${{ github.event.repository.name }} on branch ${{ github.ref }}. Job: ${{ job.name }}\"}"
          fi
